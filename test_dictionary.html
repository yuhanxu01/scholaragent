<!DOCTYPE html>
<html>
<head>
    <title>Dictionary Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-area {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            line-height: 1.6;
        }
        .popup {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Dictionary Test</h1>

    <div class="test-area" id="testArea">
        <p>This is a test paragraph. Double-click on any word like <strong>dictionary</strong>, <strong>test</strong>, or <strong>example</strong> to see dictionary lookup.</p>
        <p>You can also select text and right-click for dictionary lookup.</p>
    </div>

    <div class="popup" id="dictPopup">
        <h3 id="dictWord"></h3>
        <p id="dictDefinition"></p>
        <button onclick="closePopup()">Close</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/study';

        // Get token from localStorage (you need to be logged in)
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        async function lookupWord(word) {
            const token = getAuthToken();
            if (!token) {
                console.error('No auth token found');
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}/dictionary/lookup/?word=${encodeURIComponent(word)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Dictionary lookup failed:', error);
                return {
                    word: word,
                    definition: 'Failed to lookup word. Check console for errors.',
                    error: true
                };
            }
        }

        function showPopup(word, definition, x, y) {
            const popup = document.getElementById('dictPopup');
            const wordEl = document.getElementById('dictWord');
            const defEl = document.getElementById('dictDefinition');

            wordEl.textContent = word;
            defEl.textContent = definition;

            popup.style.left = Math.min(x, window.innerWidth - 300) + 'px';
            popup.style.top = Math.min(y, window.innerHeight - 200) + 'px';
            popup.style.display = 'block';
        }

        function closePopup() {
            document.getElementById('dictPopup').style.display = 'none';
        }

        // Handle double-click
        document.getElementById('testArea').addEventListener('dblclick', async (e) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText && selectedText.length > 0) {
                const result = await lookupWord(selectedText);
                if (result) {
                    showPopup(result.word || selectedText, result.definition || 'No definition found', e.pageX, e.pageY);
                }
            }
        });

        // Handle right-click (context menu)
        document.getElementById('testArea').addEventListener('contextmenu', async (e) => {
            e.preventDefault();

            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText && selectedText.length > 0) {
                const result = await lookupWord(selectedText);
                if (result) {
                    showPopup(result.word || selectedText, result.definition || 'No definition found', e.pageX, e.pageY);
                }
            }
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('dictPopup');
            if (!popup.contains(e.target)) {
                closePopup();
            }
        });

        console.log('Dictionary test page loaded. Make sure you are logged in to the main app first.');
    </script>
</body>
</html>